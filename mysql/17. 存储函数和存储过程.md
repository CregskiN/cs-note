# 17. 存储函数和存储过程

[TOC]

<img src="https://www.qiniu.cregskin.com/image-20201028230334279.png" alt="image-20201028230334279" style="zoom:50%;" />

## 1. 存储函数

### 1.1 创建存储函数

`存储函数`：就是一种函数，不过在这个函数里可以执行 MySql 语句

```mysql
CREATE FUNCTION 存储函数名称([参数列表])
RETURNS 返回值类型
BEGIN
	函数体内容
END
```

定义一个 avg_score 函数，接收一个 VARCHAR(100) 类型的参数，返回类型为 DOUBLE，

```mysql
mysql> delimiter $
mysql> CREATE FUNCTION avg_score(s VARCHAR(100))
    -> RETURNS DOUBLE
    -> BEGIN
    ->     RETURN (SELECT AVG(score) FROM student_score WHERE subject = s);
    -> END $
Query OK, 0 rows affected (0.00 sec)

mysql> delimiter ;
```

```mysql
> ERROR: This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you *might* want to use the less safe log_bin_trust_function_creators variable)

这是我们开启了bin-log, 我们就必须指定我们的函数是否是
1 DETERMINISTIC 不确定的
2 NO SQL 没有SQl语句，当然也不会修改数据
3 READS SQL DATA 只是读取数据，当然也不会修改数据
4 MODIFIES SQL DATA 要修改数据
5 CONTAINS SQL 包含了SQL语句

其中在function里面，只有 DETERMINISTIC, NO SQL 和 READS SQL DATA 被支持。如果我们开启了 bin-log, 我们就必须为我们的function指定一个参数。
```

```
SET GLOBAL log_bin_trust_function_creators = 1;
```



### 1.2 存储函数的调用

```mysql
mysql> SELECT avg_score('母猪的产后护理');
+------------------------------------+
| avg_score('母猪的产后护理')        |
+------------------------------------+
|                                 73 |
+------------------------------------+
1 row in set (0.00 sec)

mysql> SELECT avg_score('论萨达姆的战争准备');
+------------------------------------------+
| avg_score('论萨达姆的战争准备')          |
+------------------------------------------+
|                                    73.25 |
+------------------------------------------+
1 row in set (0.00 sec)

mysql>
```





### 1.3 查看和删除存储函数

```mysql
SHOW FUNCTION STATUS [LIKE 需要匹配的函数名];
```

```mysql
SHOW CREATE FUNCTION 函数名;
```

```mysql
DROP FUNCTION 函数名;
```



### 1.4 存储函数函数体

#### 定义局部变量 - DELCATE

```mysql
DECLARE 变量名1, 变量名2, ... 数据类型 [DEFAULT 默认值];
```

> 函数体中，局部变量名不允许加@前缀，与之前的SET语法截然不同

```mysql
DELIMITER $;

CREATE FUNCTION var_demo()
RETURNS INT
BEGIN
	DECLARE c INT;
	SET c = 5;
	RETURN c;
END $
```

```mysql
DELIMITER $;

CREATE FUNCTION var_default_demo()
RETURNS INT
BEGIN 
	DECLARE c INT DEFAULT 1;
	RETURN c;
END $
```



#### 使用自定义变量 - SET @abc

在函数体内部定义并使用 @abc

```mysql
mysql> delimiter $
mysql> SET @abc;
mysql> CREATE FUNCTION user_defined_var_demo()
    -> RETURNS INT
    -> BEGIN
    ->     SET @abc = 10;
    ->     return @abc;
    -> END $
Query OK, 0 rows affected (0.00 sec)

mysql>
mysql> delimiter ;
mysql>
```

这样的函数执行完毕后，@abc 在函数体外，也可以访问

```mysql
mysql> SELECT user_defined_var_demo();
+-------------------------+
| user_defined_var_demo() |
+-------------------------+
|                      10 |
+-------------------------+
1 row in set (0.01 sec)

mysql> SELECT @abc;
+------+
| @abc |
+------+
|   10 |
+------+
1 row in set (0.00 sec)

mysql>
```

> 与直接 DECLARE 声明局部变量有明显区别



#### 判断语句 - IF ELSEIF THEN ELSE

```mysql
IF 表达式 THEN
	处理语句列表
[ELSEIF 表达式 THEN
	处理语句列表
]
[ELSEIF 表达式 THEN
	处理语句列表
]
...
[ELSE
	处理语句列表
]
END IF;
```

```mysql
mysql> delimiter $
mysql> CREATE FUNCTION condition_demo(i INT)
-> RETURNS VARCHAR(10)
-> BEGIN
->     DECLARE result VARCHAR(10);
->     IF i = 1 THEN
->         SET result = '结果是1';
->     ELSEIF i = 2 THEN
->         SET result = '结果是2';
->     ELSEIF i = 3 THEN
->         SET result = '结果是3';
->     ELSE
->         SET result = '非法参数';
->     END IF;
->     RETURN result;
-> END $
Query OK, 0 rows affected (0.00 sec)

mysql> delimiter ;
mysql>
```



#### 循环语句 - 三种

MySql 有三种循环语句

1. WHILE

   先判断，后循环

```mysql
WHILE 表达式 D0
	处理语句列表
END WHILE;
```

```mysql
mysql> delimiter $
mysql> CREATE FUNCTION sum_all(n INT UNSIGNED)
-> RETURNS INT
-> BEGIN
->     DECLARE result INT DEFAULT 0;
->     DECLARE i INT DEFAULT 1;
->     WHILE i <= n DO
->         SET result = result + i;
->         SET i = i + 1;
->     END WHILE;
->     RETURN result;
-> END $
Query OK, 0 rows affected (0.00 sec)

mysql> delimiter ;
mysql>
```

函数 sum_all 接收一个 无符号整型 n

返回 整形

函数内

​	定义局部变量 result 整形、默认值 0

​	定义局部变量 i 整形、默认值 0

​	循环 i <= n

​		设定局部变量 result = result + 1

​		设定局部变量 i = i + 1

​	结束循环

​	返回 result

结束



2. REPEAT

   先循环，后判断

   ```mysql
   REPEAT 
   	处理语句列表
   UNTIL 表达式 END REPEAT;
   ```

   ```mysql
   CREATE FUNCTION sum_all(n INT UNSIGNED)
   RETURNS INT
   BEGIN
   	DECLARE result INT UNSIGNED DEFAULT 0;
   	DECLARE i INT DEFAULT 1;
   	REPEAT 
   		SET result = result + i;
   		SET i = i + 1;
     UNTIL i > n END REPEAT;
   END
   ```

   

3. LOOP

   ```mysql
   LOOP
   	处理语句列表
   END LOOP;
   ```

   LOOP 没有循环条件，但可以用 IF + RETURN 结束函数，以结束循环

   ```mysql
   CREATE FUNCTION sum_all(n INT UNSIGNED)
   RETURNS INT
   	DECLARE result INT DEFAULT 0;
   	DECLARE i INT DEFAULT 1;
   	LOOP
   		IF i > n THEN
   			RETURN result;
   		END IF;
   		SET result = result + i;
   		SET i = i + 1;
   	END LOOP;
   END
   ```

   也可以强用 LEAVE 结束循环，前提是做好 标记

   ```mysql
   CREATE FUNCTION sum_all(n INT UNSIGNED)
   RETURNS INT
   BEGIN 
   	DECLARE result INT DEFAULT 0;
   	DECLARE i INT DEFAULT 1;
   	flat: 
       LOOP
         IF i > n THEN
           LEAVE flag; -- 结束 flat 标记代表的循环逻辑
         END IF;
         SET result = result + i;
         SET i = i + 1;
       END LOOP flag;
      RETURN result;
   END
   ```



## 2. 存储过程



<img src="https://www.qiniu.cregskin.com/image-20201028230334279.png" alt="image-20201028230334279" style="zoom:50%;" />

存储函数 和 存储过程 区别：

存储函数 侧重于执行这些语句，并返回一个值

存储过程 侧重于单纯执行语句

### 2.1 创建存储过程

> `PROCEDURE`：程序

```mysql
CREATE PROCEDURE 存储过程名称([参数列表])
BEGIN
	需要执行的语句
END
```

与 存储函数 最直观的不同，就是没有返回值

```mysql
CREATE PROCEDURE t1_operation(m1_value INT, n1_value CHAR(1))
BEGIN
	SELECT * FROM t1;
	INSERT INTO t1(m1, n1) VALUES (m1_value, n1_value);
	SELECT * FROM t1;
END
```

该存储过程功能：

接收两个参数 m1_value n1_value

插入到 t1 表



### 2.2 存储过程的调用



### 2.3 查看和删除存储过程



### 2.4 存储过程中的语句



### 2.5 存储过程的参数前缀



## 3. 存储函数和存储过程的不同点













































