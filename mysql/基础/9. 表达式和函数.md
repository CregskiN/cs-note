# 9. 表达式和函数

[TOC]



## 1. 表达式

### 1.1 操作数

1 + 1 = 2 中的 1，就是操作数



MySql 操作数如下几类：

1. 常数
2. 列名
3. 函数调用
4. 标量自查询或行自查询
5. 其他表达式
6. other





### 1.2 操作符

1. 算术操作符

   | 操作符 |   示例    |         描述         |
   | :----: | :-------: | :------------------: |
   |  `+`   |  `a + b`  |         加法         |
   |  `-`   |  `a - b`  |         减法         |
   |  `*`   |  `a * b`  |         乘法         |
   |  `/`   |  `a / b`  |       算数除法       |
   | `DIV`  | `a DIV b` | 除法，取商的整数部分 |
   |  `%`   |  `a % b`  |         取余         |
   |  `-`   |   `-a`    |         负号         |

   > DIV 表示取整，/ 表示算数除法

   

2. 比较操作符

   |    操作符     |           示例           |             描述              |
   | :-----------: | :----------------------: | :---------------------------: |
   |      `=`      |         `a = b`          |            a等于b             |
   | `<>`或者`!=`  |         `a <> b`         |           a不等于b            |
   |      `<`      |         `a < b`          |            a小于b             |
   |     `<=`      |         `a <= b`         |         a小于或等于b          |
   |      `>`      |         `a > b`          |            a大于b             |
   |     `>=`      |         `a >= b`         |         a大于或等于b          |
   |   `BETWEEN`   |   `a BETWEEN b AND c`    |       满足 b <= a <= c        |
   | `NOT BETWEEN` | `a NOT BETWEEN b AND c`  |      不满足 b <= a <= c       |
   |     `IN`      |   `a IN (b1, b2, ...)`   |   a是b1, b2, ... 中的某一个   |
   |   `NOT IN`    | `a NOT IN (b1, b2, ...)` | a不是b1, b2, ... 中的任意一个 |
   |   `IS NULL`   |       `a IS NULL`        |         a的值是`NULL`         |
   | `IS NOT NULL` |     `a IS NOT NULL`      |        a的值不是`NULL`        |
   |    `LIKE`     |        `a LIKE b`        |            a匹配b             |
   |  `NOT LIKE`   |      `a NOT LIKE b`      |           a不匹配b            |

   

3. 逻辑操作符

   | 操作符 |   示例    |                 描述                 |
   | :----: | :-------: | :----------------------------------: |
   | `AND`  | `a AND b` |    只有a和b同时为真，表达式才为真    |
   |  `OR`  | `a OR b`  | 只要a或b有任意一个为真，表达式就为真 |
   | `XOR`  | `a XOR b` |   a和b有且只有一个为真，表达式为真   |



### 1.3 表达式的使用

1. 在 SELECT 中

   <img src="https://www.qiniu.cregskin.com/image-20201021224336518.png" alt="image-20201021224336518" style="zoom: 50%;" />

   添加别名

   <img src="https://www.qiniu.cregskin.com/image-20201021224507770.png" alt="image-20201021224507770" style="zoom:50%;" />

2. 作为搜索条件

   <img src="https://www.qiniu.cregskin.com/image-20201021222242731.png" alt="image-20201021222242731" style="zoom:50%;" />



## 2. 函数

### 2.1 文本处理函数

|    名称     |           调用示例            |  示例结果   |                            描述                             |
| :---------: | :---------------------------: | :---------: | :---------------------------------------------------------: |
|   `LEFT`    |      `LEFT('abc123', 3)`      |    `abc`    |          从左取子串：从 ‘abc123’ 左侧起取 3 个字符          |
|   `RIGHT`   |     `RIGHT('abc123', 3)`      |    `123`    |          从右取子串：从 ‘abc123’ 右侧起取 3 个字符          |
|  `LENGTH`   |        `LENGTH('abc')`        |     `3`     |               计算字符串长度：计算 'abc' 长度               |
|   `LOWER`   |        `LOWER('ABC')`         |    `abc`    |                    给定字符串的小写格式                     |
|   `UPPER`   |        `UPPER('abc')`         |    `ABC`    |                    给定字符串的大写格式                     |
|   `LTRIM`   |        `LTRIM(' abc')`        |    `abc`    |               左侧除空：删除字符串左侧的空格                |
|   `RTRIM`   |        `RTRIM('abc ')`        |    `abc`    |               右侧除空：删除字符串右侧的空格                |
| `SUBSTRING` |  `SUBSTRING('abc123', 2, 3)`  |    `bc1`    | 截取子串：从 'abc123' 中第 2 个字符开始，截取三个字符并返回 |
|  `CONCAT`   | `CONCAT('abc', '123', 'xyz')` | `abc123xyz` |             连接：连接 'abc' '123' 'xyz' 并返回             |



### 2.2 日期和时间处理函数

下边有些函数会用到当前日期，我编辑文章的日期是`2019-08-28`，在实际调用这些函数时以你的当前时间为准。

|     名称      |                     调用示例                      |       示例结果        |                             描述                             |
| :-----------: | :-----------------------------------------------: | :-------------------: | :----------------------------------------------------------: |
|     `NOW`     |                      `NOW()`                      | `2019-08-16 17:10:43` |                      返回当前日期和时间                      |
|   `CURDATE`   |                    `CURDATE()`                    |     `2019-08-16`      |                         返回当前日期                         |
|   `CURTIME`   |                    `CURTIME()`                    |      `17:10:43`       |                         返回当前时间                         |
|    `DATE`     |           `DATE('2019-08-16 17:10:43')`           |     `2019-08-16`      |               将给定日期和时间值的日期提取出来               |
|  `DATE_ADD`   | `DATE_ADD('2019-08-16 17:10:43', INTERVAL 2 DAY)` | `2019-08-18 17:10:43` |            将给定的日期和时间值添加指定的时间间隔            |
|  `DATE_SUB`   | `DATE_SUB('2019-08-16 17:10:43', INTERVAL 2 DAY)` | `2019-08-14 17:10:43` |            将给定的日期和时间值减去指定的时间间隔            |
|  `DATEDIFF`   |      `DATEDIFF('2019-08-16', '2019-08-17');`      |         `-1`          | 返回两个日期之间的天数（负数代表前一个参数代表的日期比较小） |
| `DATE_FORMAT` |          `DATE_FORMAT(NOW(),'%m-%d-%Y')`          |     `08-16-2019`      |                  用给定的格式显示日期和时间                  |

+ 在使用`DATE_ADD`和`DATE_SUB`这两个函数时需要注意，增加或减去的时间间隔单位可以自己定义，下边是`MySQL`支持的一些时间单位：

  |   时间单位    | 描述 |
  | :-----------: | :--: |
  | `MICROSECOND` | 毫秒 |
  |   `SECOND`    |  秒  |
  |   `MINUTE`    | 分钟 |
  |    `HOUR`     | 小时 |
  |     `DAY`     |  天  |
  |    `WEEK`     | 星期 |
  |    `MONTH`    |  月  |
  |   `QUARTER`   | 季度 |
  |    `YEAR`     |  年  |

  让`2019-08-16 17:10:43`这个时间值增加2分钟

  ```sql
  SELECT DATE_ADD('2019-08-16 17:10:43', INTERVAL 2 DAY);
  ```

  ![image-20201021225802817](https://www.qiniu.cregskin.com/image-20201021225802817.png)

  

+ 在使用`DATE_FORMAT`函数时需要注意，我们可以通过一些所谓的`格式符`来自定义日期和时间的显示格式，下边是`MySQL`中常用的一些日期和时间的格式符以及它们对应的含义：

  | 格式符 |                          描述                           |
  | :----: | :-----------------------------------------------------: |
  |  `%b`  |           简写的月份名称（Jan、Feb、...、Dec)           |
  |  `%D`  | 带有英文后缀的月份中的日期（0th、1st、2nd、...、31st)） |
  |  `%d`  |       数字格式的月份中的日期(00、01、02、...、31)       |
  |  `%f`  |                  微秒（000000-999999）                  |
  |  `%H`  |               二十四小时制的小时 (00-23)                |
  |  `%h`  |                十二小时制的小时 (01-12)                 |
  |  `%i`  |                  数值格式的分钟(00-59)                  |
  |  `%M`  |       月份名（January、February、...、December）        |
  |  `%m`  |                  数值形式的月份(00-12)                  |
  |  `%p`  |          上午或下午（AM代表上午、PM代表下午）           |
  |  `%S`  |                        秒(00-59)                        |
  |  `%s`  |                        秒(00-59)                        |
  |  `%W`  |         星期名（Sunday、Monday、...、Saturday）         |
  |  `%w`  |      周内第几天 （0=星期日、1=星期一、 6=星期六）       |
  |  `%Y`  |               4位数字形式的年（例如2019）               |
  |  `%y`  |                2位数字形式的年（例如19）                |

  把我们想要的显示格式用对应的格式符描述出来

  ```sql
  SELECT DATE_FORMAT(NOW(), '%b %D %Y %H:%i:%s');
  ```

  ![image-20201021230448111](https://www.qiniu.cregskin.com/image-20201021230448111.png)





### 2.3 数值处理函数

下边列举一些数学上常用到的函数，在遇到需要数学计算的业务时会很有用：

|  名称  |   调用示例    |       示例结果       |        描述        |
| :----: | :-----------: | :------------------: | :----------------: |
| `ABS`  |   `ABS(-1)`   |         `1`          |      取绝对值      |
|  `Pi`  |    `PI()`     |      `3.141593`      |     返回圆周率     |
| `COS`  |  `COS(PI())`  |         `-1`         | 返回一个角度的余弦 |
| `EXP`  |   `EXP(1)`    | `2.718281828459045`  |  返回e的指定次方   |
| `MOD`  |  `MOD(5,2)`   |         `1`          |   返回除法的余数   |
| `RAND` |   `RAND()`    | `0.7537623539136372` |   返回一个随机数   |
| `SIN`  | `SIN(PI()/2)` |         `1`          | 返回一个角度的正弦 |
| `SQRT` |   `SQRT(9)`   |         `3`          | 返回一个数的平方根 |
| `TAN`  |   `TAN(0)`    |         `0`          | 返回一个角度的正切 |



### 2.4 聚集函数

对数据作统计的函数

| 函数名  |       描述       |
| :-----: | :--------------: |
| `COUNT` |  返回某列的行数  |
|  `MAX`  | 返回某列的最大值 |
|  `MIN`  | 返回某列的最小值 |
|  `SUM`  |  返回某列值之和  |
|  `AVG`  | 返回某列的平均值 |

#### 1. COUNT 函数

有两种用法

+ COUNT(*) 对表中行的数目计数，不忽略 NULL 行

+ COUNT(列名) 对特定列技术，忽略 NULL 行

  ```sql
  SELECT COUNT(*) FROM student_info;
  ```

  <img src="https://www.qiniu.cregskin.com/image-20201022080526802.png" alt="image-20201022080526802" style="zoom:67%;" />

> 尽量不使用 COUNT(*) 吃性能

#### 2. MAX 函数

```sql
SELECT MAX(score) FROM student_info;
```

<img src="https://www.qiniu.cregskin.com/image-20201022080738395.png" alt="image-20201022080738395" style="zoom:67%;" />

#### 3. SUM 函数

```sql
SELECT SUM(score) FROM student_score;
```

<img src="https://www.qiniu.cregskin.com/image-20201022080816958.png" alt="image-20201022080816958" style="zoom:67%;" />

#### 3. AVG 函数

查询 课程'母猪的产后护理' 的平均分（ NULL 行自动忽略）

```sql
SELECT AVG(score) FROM student_score WHERE subject = '母猪的产后护理';
```

<img src="https://www.qiniu.cregskin.com/image-20201022080913169.png" alt="image-20201022080913169" style="zoom:67%;" />



#### 4. 聚集函数中 DISTINCT 的使用

查询 student_info 中存储了多少个学生信息

```sql
SELECT COUNT(DISTINCT major) FROM student_info;
```

<img src="https://www.qiniu.cregskin.com/image-20201022081339371.png" alt="image-20201022081339371" style="zoom:67%;" />





#### 5. 组合聚集函数

逗号隔开即可

```sql
SELECT COUNT(*) AS 成绩记录总数, MAX(score) AS 最高成绩, MIN(score) AS 最低成绩, AVG(score) 平均成绩 FROM student_score;
```

![image-20201022081513826](https://www.qiniu.cregskin.com/image-20201022081513826.png)







## 3. 隐式类型转换

### 3.1 场景

#### 1. 把操作数转为适合计算的类型

```shell
mysql> SELECT 1 + 2, '1' + 2, '1' + '2';
+-------+---------+-----------+
| 1 + 2 | '1' + 2 | '1' + '2' |
+-------+---------+-----------+
|     3 |       3 |         3 |
+-------+---------+-----------+
1 row in set (0.00 sec)

mysql>
```



#### 2. 将函数参数转为该函数期望的类型

```shell
mysql> SELECT CONCAT('1', '2'), CONCAT('1', 2), CONCAT(1, 2);
+------------------+----------------+--------------+
| CONCAT('1', '2') | CONCAT('1', 2) | CONCAT(1, 2) |
+------------------+----------------+--------------+
| 12               | 12             | 12           |
+------------------+----------------+--------------+
1 row in set (0.00 sec)

mysql>
```





#### 3. 存储数据时转为列需要的类型

```shell
mysql> INSERT INTO t(i1, i2, s) VALUES('100', '100', 200);
Query OK, 1 row affected (0.01 sec)

mysql>
```



```sql
mysql> SELECT * FROM t;
+------+------+------+
| i1   | i2   | s    |
+------+------+------+
|  100 |  100 | 200  |
+------+------+------+
1 row in set (0.00 sec)

mysql>
```



### 3.2 类型转换注意事项

1. 遇到不适合下一步操作的类型，MySql 不会报错，而是自己转换

   ```shell
   '23sfd'         →   23
   '2019-08-28'    →   2019
   '11:30:32'      →   11
   'sfd'           →   0
   ```

   

2. 在运算时，自动提升操作数类型

   如：

   ![image-20201022083138394](https://www.qiniu.cregskin.com/image-20201022083138394.png)

   其中的`i1`列和`i2`列的类型都是`TINYINT`，而`TINYINT`能表示的最大正整数是`127`

   如果我们把`i1`列的值和`i2`列的值相加会发生什么呢？请看：

   ​	![image-20201022083202607](../../../../Library/Application Support/typora-user-images/image-20201022083202607.png)
   
   可以看到最后的结果是`200`，可是它已经超过`TINYINT`类型的表示范围了。其实在运算的过程中，`MySQL`自动将整数类型的操作数提升到了`BIGINT`，这样就不会产生运算结果太大超过`TINYINT`能表示的数值范围的尴尬情况了。类似的，有浮点数的运算过程会把操作数自动转型为`DOUBLE`类型。



> 小贴士： 
>
> 有隐式类型转换，自然也有显式类型转换。在MySQL中，可以使用CAST函数完成显式地类型转换，就是我们明确指定要将特定的数值转换为某种特定类型，不过我们并不打算这个函数的使用，感兴趣的同学可以到文档中看看哈（我们不详细展开讲，自然是该知识点对于初学者并不是那么重要哈）。